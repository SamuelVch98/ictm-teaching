{% extends "layout.html" %}
{% block pagetitle %}Course informations{% endblock %}
{% block additionalpageheader %}
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            max-width: 800px;
            margin-top: 50px;
        }

        .select2-container {
            width: 100% !important;
        }

        .select2-selection--multiple {
            min-height: 38px;
        }
    </style>
    <script>
        $(document).ready(function () {
            function formatTeacher(teacher) {
                if (teacher.loading) {
                    return teacher.text;
                }
                var $container = $("<div></div>").text(teacher.text);
                return $container;
            }

            // Ajouter un gestionnaire d'événements pour chaque champ de sélection
            $('[id^=assigned_teachers]').each(function () {
                $(this).select2({
                    placeholder: 'Search for a teacher',
                    multiple: true,
                    minimumInputLength: 1,
                    ajax: {
                        url: "{{ url_for('course.search_teachers') }}",
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return {
                                q: params.term
                            };
                        },
                        processResults: function (data) {
                            return {
                                results: data
                            };
                        },
                        cache: true
                    },
                    templateResult: formatTeacher,
                    templateSelection: formatTeacher,
                    tags: false
                });
            });
        });
    </script>
{% endblock %}
{% block pagecontent %}
    <h1 class="page-header">{{ course.code }} - {{ course.title }}</h1>
    <hr>
    <h2 class="sub-header">Course informations</h2>
    <hr>
    <div class="row">
        <div class="col-sm-9">
            <ul class="nav nav-tabs">
                {% for year in all_years %}
                    <li class="nav-item">
                        <a class="nav-link {% if year.year == course.year %} active {% endif %}"
                           data-bs-toggle="tab" href="#year-{{ year.year }}" aria-expanded="false">
                            {{ year.year }}
                        </a>
                    </li>
                {% endfor %}
            </ul>
            <div class="tab-content">
                {% for year in all_years %}
                    <div class="tab-pane {% if year.year == course.year %} active {% endif %}"
                         id="year-{{ year.year }}">
                        <form class="form" action="{{ url_for('course.update_course_info') }}" method="post"
                              id="courseInfo">
                            <input type="hidden" name="course_id" value="{{ year.id }}">
                            <div class="form-group">
                                <div class="col-xs-6">
                                    <br>
                                    <label for="code"><h4>Code</h4></label>
                                    <input type="text" class="form-control" name="code" id="code"
                                           placeholder="Code" value="{{ year.code }}">
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-xs-6">
                                    <br>
                                    <label for="title"><h4>Title</h4></label>
                                    <input type="text" class="form-control" name="title" id="title"
                                           placeholder="Title"
                                           value="{{ year.title }}">
                                </div>
                            </div>
                            <br>
                            <div class="form-group">
                                <label for="quadri"><h4>Quadri</h4></label>
                                <select class="form-select" id="quadri" name="quadri">
                                    {% for q in quadri %}
                                        {% if q == year.quadri %}
                                            <option value="{{ q }}" selected>{{ q }}</option>
                                        {% else %}
                                            <option value="{{ q }}">{{ q }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            <br>
                            <div class="form-group">
                                <label for="year"><h4>Year</h4></label>
                                <select class="form-select" id="year" name="year">
                                    {% for y in years %}
                                        {% if y == year.year %}
                                            <option value="{{ y }}" selected>{{ y }}</option>
                                        {% else %}
                                            <option value="{{ y }}">{{ y }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            <br>
                            <div class="form-group">
                                <div class="col-xs-6">
                                    <label for="load_needed"><h4>Load Needed</h4></label>
                                    <input type="text" class="form-control" name="load_needed" id="load_needed"
                                           value="{{ year.load_needed }}">
                                </div>
                            </div>
                            <br>
                            <div class="form-group">
                                <label for="language"><h4>Language</h4></label>
                                <select class="form-select" id="language" name="language">
                                    {% for lang in language %}
                                        {% if lang == 'fr' %}
                                            <option value="{{ lang }}"
                                                    {% if year.language == lang %}selected{% endif %}>French
                                            </option>
                                        {% else %}
                                            <option value="{{ lang }}"
                                                    {% if year.language == lang %}selected{% endif %}>English
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <br>
                                <label for="assigned_teachers"><h4>Assign Teachers</h4></label>
                                <select class="form-control" id="assigned_teachers_{{ year.year }}"
                                        name="assigned_teachers[]" multiple>
                                    {% for assigned_teacher in all_teachers %}
                                        {% if assigned_teacher.course_year == year.year %}
                                            <option value="{{ assigned_teacher.user_id }}"
                                                    selected>{{ assigned_teacher.user.name }} {{ assigned_teacher.user.first_name }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <div class="col-xs-12">
                                    <br>
                                    <button class="btn btn-lg btn-success" type="submit"><i
                                            class="glyphicon glyphicon-ok-sign"></i> Save
                                    </button>
                                    <a href="{{ url_for('course.duplicate_course', course_id=year.id, year=year.year) }}" class="btn btn-lg btn-success">Duplicate Course</a>
                                </div>
                            </div>
                        </form>
                        <hr>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}
